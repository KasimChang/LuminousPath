<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å››æŸ±å…«å­— - LuminousPath Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, limit } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCf5q4CJehSCnml8w_sOC27igtNt637Th4",
            authDomain: "fir-console-86c87.firebaseapp.com",
            projectId: "fir-console-86c87",
            storageBucket: "fir-console-86c87.firebasestorage.app",
            messagingSenderId: "1074159437762",
            appId: "1:1074159437762:web:d6f9a3f81ebeed2ebe785b",
            measurementId: "G-3LB4W975PE"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.FirebaseSDK = { 
            app, auth, db,
            firebaseConfig, initializeApp, getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, 
            getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, query, limit,
            signInWithCustomToken, signInAnonymously 
        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Noto+Sans+TC:wght@300;400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; overflow-x: hidden; }
        .font-serif { font-family: 'Noto Serif TC', serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fortune-table { table-layout: fixed; width: 100%; border-collapse: collapse; }
        .fortune-table td, .fortune-table th { border: 1px solid rgba(71, 85, 105, 0.4); padding: 4px 0px; vertical-align: middle; text-align: center; }
        .flow-year-row { height: 38px; display: flex; flex-direction: column; justify-content: center; align-items: center; transition: all 0.2s; position: relative; }
        .highlight-year { background: rgba(234, 179, 8, 0.15) !important; box-shadow: inset 0 0 0 1px #eab308; border-radius: 2px; }
        .safe-top { padding-top: env(safe-area-inset-top); }
        .loading-shimmer { background: linear-gradient(90deg, transparent 25%, rgba(16, 185, 129, 0.1) 50%, transparent 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite; }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
    </style>
</head>
<body class="flex flex-col min-h-screen transition-colors duration-300 text-center">
    <div id="root" class="flex-grow flex flex-col"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback, useRef } = React;

        const ADMIN_UID = "H5dBIA0UxyYo8oV5GZ442u5yZ733";
        const BRANCHES = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
        const WORKER_URL = "https://luminouspath.l321815.workers.dev/";

        const toTC = (str) => { if (!str) return ""; return str.replace(/è…Š/g, "è‡˜").replace(/æƒŠè›°/g, "é©šèŸ„").replace(/æ™‚/g, "æ™‚").replace(/ç¯€/g, "ç¯€").replace(/æ°£/g, "æ°£"); };

        const GoogleIcon = () => (
            <svg className="w-4 h-4 mr-2" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24s.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path></svg>
        );

        const AnalysisBox = ({ title, content, isDark }) => {
            if (!content) return null;
            return (
                <div className={`p-4 sm:p-6 rounded-2xl border transition-all duration-300 ${isDark ? "bg-slate-900/60 border-slate-700" : "bg-white border-slate-200 shadow-sm"}`}>
                    <p className="text-[12px] font-bold text-emerald-500 uppercase tracking-widest mb-3">{title}</p>
                    <div className="space-y-2 text-xs sm:text-sm leading-relaxed opacity-90 font-medium text-left">
                        {content.split('\n').filter(line => line.trim() !== '').map((line, idx) => (<p key={idx}>{line}</p>))}
                    </div>
                </div>
            );
        };

        const App = () => {
            const CURRENT_REAL_YEAR = new Date().getFullYear();
            const [isDark, setIsDark] = useState(false); 
            const [gender, setGender] = useState('male');
            const [threshold, setThreshold] = useState(0);
            const [isDst, setIsDst] = useState(false);

            const [gregYear, setGregYear] = useState(2026);
            const [rocYear, setRocYear] = useState(115);
            const [month, setMonth] = useState(2);
            const [day, setDay] = useState(4);
            const [hour, setHour] = useState(4); 
            const [minute, setMinute] = useState(10);

            const [calYear, setCalYear] = useState(new Date().getFullYear());
            const [calMonth, setCalMonth] = useState(new Date().getMonth() + 1);
            const [calendarData, setCalendarData] = useState(null);
            const [isCalLoading, setIsCalLoading] = useState(false);

            const [chartData, setChartData] = useState(null);
            const [isLoading, setIsLoading] = useState(false);
            const [error, setError] = useState(null);
            
            const baziAbortRef = useRef(null);
            const calAbortRef = useRef(null);

            const [user, setUser] = useState(null);
            const [profiles, setProfiles] = useState([]);
            const [saveInputName, setSaveInputName] = useState("");

            const isAdmin = useMemo(() => user && user.uid === ADMIN_UID, [user]);
            const isLoggedIn = useMemo(() => !!user, [user]);

            const ELEMENT_STYLES = useMemo(() => ({
                'é‡‘': { color: isDark ? 'text-slate-400' : 'text-slate-600', bg: 'bg-slate-400', bar: 'bg-slate-400' },
                'æœ¨': { color: isDark ? 'text-emerald-500' : 'text-emerald-700', bg: 'bg-emerald-500', bar: 'bg-emerald-500' },
                'æ°´': { color: isDark ? 'text-blue-500' : 'text-blue-700', bg: 'bg-blue-500', bar: 'bg-blue-500' },
                'ç«': { color: isDark ? 'text-red-500' : 'text-red-600', bg: 'bg-red-500', bar: 'bg-red-500' },
                'åœŸ': { color: isDark ? 'text-[#a57c5a]' : 'text-[#8b4513]', bg: 'bg-[#a57c5a]', bar: 'bg-[#a57c5a]' },
                'none': { color: isDark ? 'text-slate-400' : 'text-slate-950', bg: isDark ? 'bg-slate-800' : 'bg-slate-200' }
            }), [isDark]);

            // å§»ç·£æ¡ƒèŠ±åœ–ç¤ºçµ„ä»¶ï¼šä¿®æ­£å°é½Šé‚è¼¯ï¼Œé©é… iPhone 16 Pro ä¸¦å„ªåŒ–æ‰‹æ©Ÿç«¯å°ºå¯¸æ¯”ä¾‹
            const RomanceIcon = ({ level, isCompact = false }) => {
                if (!level || !isAdmin) return null;
                // æ‰‹æ©Ÿç«¯ä½¿ç”¨æ›´å°çš„å°ºå¯¸ä»¥å…æ“ å£“ä½ˆå±€
                const containerSize = isCompact ? "w-3 h-3 sm:w-5 sm:h-5" : "w-3.5 h-3.5 sm:w-6 sm:h-6";
                const dotSize = isCompact ? "w-2.5 h-2.5 sm:w-4.5 sm:h-4.5" : "w-3 h-3 sm:w-5 sm:h-5";
                const textSize = isCompact ? "text-[6px] sm:text-[8px]" : "text-[7px] sm:text-[9px]";

                return (
                    <div className={`absolute top-0 right-0 pointer-events-none flex items-center justify-center p-0.5 ${containerSize}`}>
                        {level === 2 ? (
                            <div className={`${dotSize} rounded-full bg-pink-400/25 flex items-center justify-center`}>
                                <span className={`${textSize} font-black text-pink-500 leading-none block text-center transform translate-y-[0.1px]`}>æ¡ƒ</span>
                            </div>
                        ) : (
                            <div className="flex items-center justify-center w-full h-full">
                                <span className={`${textSize} font-black text-pink-500 leading-none`}>æ¡ƒ</span>
                            </div>
                        )}
                    </div>
                );
            };

            const hourOptions = useMemo(() => {
                const opts = [{ label: 'å‰æ™‚', val: -1 }];
                for (let i = 0; i < 24; i++) {
                    const branchIdx = Math.floor(((i + 1) % 24) / 2);
                    opts.push({ label: `${i}æ™‚ (${BRANCHES[branchIdx]})`, val: i });
                }
                return opts;
            }, []);

            const fetchBazi = useCallback(async () => {
                if (!gregYear || !month || !day) return;
                if (baziAbortRef.current) baziAbortRef.current.abort();
                baziAbortRef.current = new AbortController();
                setIsLoading(true); setError(null);
                try {
                    const headers = { "Content-Type": "application/json" };
                    if (user) { const token = await user.getIdToken(); headers["Authorization"] = `Bearer ${token}`; }
                    const response = await fetch(WORKER_URL, {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({ type: 'bazi', gregYear, month, day, hour, minute, gender, isDst, calYear, calMonth }),
                        signal: baziAbortRef.current.signal
                    });
                    const data = await response.json();
                    if (data.error) throw new Error(data.error);
                    setChartData(data);
                    if (data.calendarData) setCalendarData(data.calendarData);
                } catch (err) { if (err.name !== 'AbortError') setError("é‹ç®—å¼•æ“å¿™ç·šä¸­..è«‹ç¨å€™ 1min å†è©¦"); }
                finally { setIsLoading(false); }
            }, [gregYear, month, day, hour, minute, gender, isDst, user, calYear, calMonth]);

            const fetchCalendar = useCallback(async () => {
                if (calAbortRef.current) calAbortRef.current.abort();
                calAbortRef.current = new AbortController();
                setIsCalLoading(true);
                try {
                    const headers = { "Content-Type": "application/json" };
                    if (user) { const token = await user.getIdToken(); headers["Authorization"] = `Bearer ${token}`; }
                    const response = await fetch(WORKER_URL, {
                        method: "POST",
                        headers: headers,
                        body: JSON.stringify({ type: 'calendar', calYear, calMonth, gregYear, month, day }),
                        signal: calAbortRef.current.signal
                    });
                    const data = await response.json();
                    if (data.calendarData) setCalendarData(data.calendarData);
                } catch (e) { if (e.name !== 'AbortError') console.error("Calendar Failed"); }
                finally { setIsCalLoading(false); }
            }, [calYear, calMonth, user, gregYear, month, day]);

            useEffect(() => { fetchBazi(); }, [fetchBazi]);
            useEffect(() => { fetchCalendar(); }, [fetchCalendar]);

            useEffect(() => {
                if (!window.FirebaseSDK) return;
                const { auth, onAuthStateChanged } = window.FirebaseSDK;
                const unsubscribe = onAuthStateChanged(auth, (u) => { if (u && !u.isAnonymous) setUser(u); else setUser(null); });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !window.FirebaseSDK) { setProfiles([]); return; }
                const { db, collection, onSnapshot, query, limit } = window.FirebaseSDK;
                const unsubscribe = onSnapshot(query(collection(db, 'artifacts', 'luminous-path-pro', 'users', user.uid, 'profiles')), (snapshot) => {
                    const data = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    data.sort((a, b) => (a.order ?? 999) - (b.order ?? 999) || new Date(a.createdAt || 0) - new Date(b.createdAt || 0));
                    setProfiles(data);
                });
                return () => unsubscribe();
            }, [user]);

            const StarLabel = ({ starInfo, isDayMaster = false, isVertical = false, extraSmall = false, isFortune = false }) => {
                if (!starInfo) return null;
                const { name, element, color } = starInfo;
                const freq = (chartData && chartData.pillars) ? chartData.pillars.reduce((acc, p, i) => {
                    if (i !== 2 && p.main?.name === name) acc++;
                    p.sub?.forEach(s => { if (s.star?.name === name) acc++; });
                    return acc;
                }, 0) : 0;
                const isStrong = isFortune ? true : (threshold > 0 && !isDayMaster && freq >= threshold);
                const style = ELEMENT_STYLES[color || "none"] || ELEMENT_STYLES["none"];
                const baseStyles = "rounded border font-bold flex items-center justify-center transition-all duration-300 overflow-hidden text-center mx-auto";
                let colorStyles = (color === "none" || !color) ? (isDark ? "bg-slate-800 text-slate-400 border-slate-700" : "bg-white border-slate-300 text-slate-950") : (isDayMaster ? "bg-yellow-500 text-slate-950 border-yellow-600 shadow-md" : (isStrong ? `${style.bg} text-white border-transparent shadow-lg ring-1 ring-white/10` : (isDark ? "bg-slate-800 text-slate-200 border-slate-700 shadow-inner" : "bg-slate-100 text-slate-700 border-slate-200 shadow-sm")));
                const paddingStyles = isVertical ? "px-0.5 py-1 sm:px-1.5 sm:py-2 min-h-[4.5rem]" : "px-1.5 py-0.5 sm:px-3 sm:py-1";
                const fontStyles = isVertical ? `${extraSmall ? 'text-[9.5px]' : 'text-[11px]'} sm:text-sm leading-tight` : "text-[clamp(0.75rem,2.8vw,1.1rem)] leading-none";
                return <div className={`${baseStyles} ${colorStyles} ${paddingStyles} ${fontStyles}`} style={isVertical ? { writingMode: 'vertical-rl' } : {}}>{name}</div>;
            };

            const CharacterWithElement = ({ char, element, color, isSmall = false }) => {
                if (!char) return null;
                const style = ELEMENT_STYLES[color || "none"] || ELEMENT_STYLES["none"];
                const charSize = isSmall ? "text-lg" : "text-[clamp(1.5rem,7vw,3.2rem)]";
                return (
                    <div className="relative inline-flex items-center justify-center text-center font-serif transition-colors duration-500">
                        <span className={`${charSize} leading-none tracking-tight ${style.color}`}>{char}</span>
                        {element && element !== "none" && <span className="text-[clamp(0.45rem,1.5vw,0.65rem)] ml-px opacity-80 font-sans font-bold leading-none">{element}</span>}
                    </div>
                );
            };

            const handleLoadCase = () => { setGregYear(1977); setRocYear(66); setMonth(1); setDay(24); setHour(9); setMinute(0); setIsDst(false); };
            const handleClear = () => { setGregYear(""); setRocYear(""); setMonth(1); setDay(""); setHour(-1); setMinute(0); setIsDst(false); setChartData(null); };

            return (
                <div className={`flex-grow safe-top p-2 sm:p-4 md:p-8 font-sans transition-colors duration-300 ${isDark ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900'}`}>
                    <div className="max-w-[1200px] mx-auto space-y-3 sm:space-y-6">
                        
                        <div className="flex flex-col gap-3 border-b border-slate-800/50 pb-3 text-left">
                            <div className="flex justify-between items-center">
                                <h1 className={`text-2xl sm:text-3xl font-black tracking-tighter italic uppercase ${isDark ? 'text-emerald-500' : 'text-slate-950'}`}>å››æŸ±å…«å­—</h1>
                                <div className="flex items-center gap-2">
                                    {!isLoggedIn ? (
                                        <button onClick={async () => await window.FirebaseSDK.signInWithPopup(window.FirebaseSDK.auth, new window.FirebaseSDK.GoogleAuthProvider())} className="flex items-center px-3 py-1.5 rounded-full bg-white border border-slate-200 text-slate-700 text-xs font-bold shadow-sm hover:bg-slate-50 transition-all"><GoogleIcon />Google ç™»å…¥</button>
                                    ) : (
                                        <div className="flex items-center gap-2 pr-2 border-r border-slate-200 dark:border-slate-800 mr-1 text-right leading-none">
                                            <div className="flex flex-col"><span className="text-[12px] font-black opacity-40 uppercase">ç›®å‰ç™»å…¥ç‚º</span><span className={`text-[12px] font-bold ${isDark ? 'text-emerald-400' : 'text-emerald-600'}`}>{user.displayName || "User"} {isAdmin && "â˜…"}</span></div>
                                            <button onClick={() => window.FirebaseSDK.signOut(window.FirebaseSDK.auth)} className="p-1.5 text-slate-400 hover:text-red-500 transition-all"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg></button>
                                        </div>
                                    )}
                                    <button onClick={() => setIsDark(!isDark)} className={`p-2 rounded-full border shadow-sm transition-all ${isDark ? "bg-slate-900 border-slate-700 text-yellow-400" : "bg-white border-slate-200 text-slate-600"}`}>{isDark ? "ğŸŒ™" : "â˜€ï¸"}</button>
                                </div>
                            </div>
                            
                            <div className="flex flex-wrap items-center gap-2 sm:gap-3">
                                <div className="flex items-center gap-1.5">
                                    <button onClick={handleLoadCase} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${isDark ? 'bg-slate-800 border-slate-700 text-slate-300' : 'bg-white border-slate-200 text-slate-700 shadow-sm'}`}>è¼‰å…¥æ¡ˆä¾‹</button>
                                    <button onClick={handleClear} className={`px-3 py-1.5 rounded-lg text-xs font-bold border transition-all ${isDark ? 'bg-slate-800 border-slate-700 text-slate-300' : 'bg-white border-slate-200 text-slate-700 shadow-sm'}`}>æ¸…é™¤æ­¸é›¶</button>
                                </div>
                                {isLoggedIn && (
                                    <div className="flex items-center gap-2 flex-wrap">
                                        <div className={`flex items-center p-0.5 rounded-lg border shadow-inner transition-all ${isDark ? 'bg-slate-950 border-slate-800' : 'bg-white border-slate-200'}`}>
                                            <input type="text" value={saveInputName} onChange={(e)=>setSaveInputName(e.target.value)} placeholder="åç¨±..." className={`bg-transparent border-0 text-[10px] sm:text-xs font-bold px-1.5 py-1 outline-none w-16 sm:w-28 placeholder:opacity-30 ${isDark ? 'text-slate-200' : 'text-slate-800'}`} />
                                            <button onClick={async () => { const { db, doc, setDoc } = window.FirebaseSDK; await setDoc(doc(db, 'artifacts', 'luminous-path-pro', 'users', user.uid, 'profiles', `profile_${Date.now()}`), { name: saveInputName, gregYear, month, day, hour, minute, gender, isDst, order: profiles.length }); setSaveInputName(""); }} className="bg-emerald-600 hover:bg-emerald-500 text-white text-[12px] px-2 py-1 rounded shadow-sm transition-all">Save</button>
                                        </div>
                                        <div className="relative group text-left">
                                            <button className="px-3 py-2 rounded-lg bg-blue-600 text-white text-xs font-bold shadow-md hover:bg-blue-500 transition-all">å‘½ç›¤åˆ‡æ› ({profiles.length})</button>
                                            <div className="fixed inset-x-4 sm:absolute sm:inset-x-auto sm:right-0 sm:left-auto top-32 sm:top-full mt-2 sm:w-80 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl shadow-2xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all z-[100] no-scrollbar overflow-y-auto max-h-[60vh]">
                                                {profiles.map((p) => (<div key={p.id} onClick={() => {setGregYear(p.gregYear); setRocYear(p.gregYear - 1911); setMonth(p.month); setDay(p.day); setHour(p.hour); setMinute(p.minute); setGender(p.gender); setIsDst(p.isDst);}} className="select-none flex items-center justify-between p-3 hover:bg-slate-50 dark:hover:bg-slate-800 cursor-pointer border-b last:border-0 border-slate-100 dark:border-slate-800 text-left"><div className="flex flex-col truncate"><span className="text-xs font-bold text-slate-800 dark:text-slate-200 truncate">{p.name}</span><span className="text-[10px] text-slate-400">{p.gregYear}/{p.month}/{p.day}</span></div><button onClick={async (e) => { e.stopPropagation(); await window.FirebaseSDK.deleteDoc(window.FirebaseSDK.doc(window.FirebaseSDK.db, 'artifacts', 'luminous-path-pro', 'users', user.uid, 'profiles', p.id)); }} className="p-1 text-slate-300 hover:text-red-500"><svg className="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button></div>))}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            <div className="grid grid-cols-3 sm:grid-cols-9 gap-1.5 sm:gap-2 items-end">
                                <div className="flex flex-col gap-1 text-left"><span className="text-[10px] font-bold opacity-40 uppercase">æ€§åˆ¥</span><select value={gender} onChange={(e)=>setGender(e.target.value)} className={`rounded px-1 text-xs border h-9 appearance-none ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`}><option value="male">ç”·</option><option value="female">å¥³</option></select></div>
                                <div className="flex flex-col gap-1 text-left"><span className="text-[10px] font-bold opacity-40 uppercase">è¥¿å…ƒ</span><input type="number" value={gregYear} onChange={(e)=> {setGregYear(e.target.value); setRocYear(e.target.value-1911);}} className={`rounded px-1 text-xs border h-9 appearance-none ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`} /></div>
                                <div className="flex flex-col gap-1 text-left"><span className="text-[10px] font-bold opacity-40 uppercase">æ°‘åœ‹</span><input type="number" value={rocYear} onChange={(e)=> {setRocYear(e.target.value); setGregYear(parseInt(e.target.value)+1911);}} className={`rounded px-1 text-xs border h-9 appearance-none ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`} /></div>
                                <div className="flex flex-col gap-1 text-left"><span className="text-[10px] font-bold opacity-40 uppercase">æœˆä»½</span><select value={month} onChange={(e)=>setMonth(parseInt(e.target.value) || 1)} className={`rounded px-1 text-xs border h-9 appearance-none ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`}>{Array.from({length:12}, (_,i)=><option key={i+1} value={i+1}>{i+1}æœˆ</option>)}</select></div>
                                <div className="flex flex-col gap-1 text-left"><span className="text-[10px] font-bold uppercase">æ—¥æœŸ</span><input type="number" value={day} onChange={(e)=>setDay(e.target.value)} className={`rounded px-1 text-xs border h-9 appearance-none w-full ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`} /></div>
                                <div className="flex flex-col gap-1 text-left"><span className="text-[10px] font-bold opacity-40 uppercase">æ™‚è¾°</span><select value={hour} onChange={(e)=>setHour(parseInt(e.target.value))} className={`rounded px-1 text-[10px] sm:text-xs border h-9 appearance-none ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`}>{hourOptions.map((o,i) => <option key={i} value={o.val}>{o.label}</option>)}</select></div>
                                <div className="flex flex-col gap-1 text-left"><span className="text-[10px] font-bold opacity-40 uppercase">åˆ†é˜</span><input type="number" value={minute} onChange={(e)=>setMinute(e.target.value)} className={`rounded px-1 text-xs border h-9 appearance-none w-full ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`} /></div>
                                <div className="flex items-center gap-1 h-9 col-span-2 sm:col-span-1 text-left"><input type="checkbox" id="dst" checked={isDst} onChange={(e)=>setIsDst(e.target.checked)} className="w-4 h-4 rounded border-slate-300 text-emerald-600 focus:ring-emerald-500" /><label htmlFor="dst" className={`text-[11px] font-bold uppercase ${isDark ? 'text-slate-500' : 'text-slate-500'}`}>å¤ä»¤æ™‚é–“</label></div>
                            </div>
                        </div>

                        {error && <div className="p-3 bg-red-500/10 border border-red-500 text-red-500 text-xs font-bold rounded-lg mb-4">{error}</div>}

                        <div className={`rounded-xl border overflow-hidden shadow-xl transition-all duration-300 ${isLoading ? 'opacity-50 pointer-events-none' : 'opacity-100'} ${isDark ? "bg-slate-900/40 border-slate-700" : "bg-white border-slate-200"}`}>
                            {['å››æŸ±', 'ä¸»æ˜Ÿ', 'å¤©å¹²', 'åœ°æ”¯', 'è—å¹²', 'å‰¯æ˜Ÿ'].map((label, rIdx) => {
                                const id = ['pillar', 'main', 'stem', 'branch', 'sub_char', 'sub_star'][rIdx];
                                return (
                                    <div key={id} className={`grid grid-cols-[16%_21%_21%_21%_21%] border-b last:border-0 ${isDark ? "border-slate-700" : "border-slate-200"}`}>
                                        <div className={`flex items-center justify-center border-r font-bold text-[clamp(0.7rem,3vw,1rem)] uppercase text-center ${isDark ? "bg-slate-900/40 text-slate-500 border-slate-700" : "bg-slate-50/50 text-slate-400"}`}>{label}</div>
                                        {(chartData && chartData.pillars) ? chartData.pillars.map((p, pIdx) => (
                                            <div key={pIdx} className={`relative flex flex-col items-center justify-center p-1.5 sm:p-4 border-r last:border-0 ${isDark ? "border-slate-700" : "border-slate-200"}`}>
                                                {id === 'pillar' && <span className={`font-bold text-[10px] sm:text-sm ${p.label === 'æ—¥æŸ±' ? (isDark ? "text-yellow-500" : "text-yellow-600") : (isDark ? "text-slate-300" : "text-slate-600")}`}>{p.label}</span>}
                                                {id === 'main' && (hour === -1 && pIdx === 3 ? <span className="opacity-20 text-[10px]">ï¼</span> : <StarLabel starInfo={p.main} isDayMaster={p.label === 'æ—¥æŸ±'} />)}
                                                {id === 'stem' && (hour === -1 && pIdx === 3 ? <span className="text-2xl font-serif text-emerald-500">å‰</span> : <CharacterWithElement char={p.stem} element={p.stemElement} color={p.stemColor} />)}
                                                {id === 'branch' && (hour === -1 && pIdx === 3 ? <span className="text-2xl font-serif text-emerald-500">æ™‚</span> : <CharacterWithElement char={p.branch} element={p.branchElement} color={p.branchColor} />)}
                                                {id === 'sub_char' && (hour === -1 && pIdx === 3 ? <span className="opacity-20 text-[10px]">ï¼</span> : <div className="grid grid-cols-3 w-full gap-0 px-0.5">{p.sub?.map((s, sIdx) => <div key={sIdx} className="flex justify-center items-center h-8 text-center"><CharacterWithElement char={s.char} element={s.star?.element} color={s.star?.color} isSmall /></div>)}</div>)}
                                                {id === 'sub_star' && (hour === -1 && pIdx === 3 ? <span className="opacity-20 text-[10px]">ï¼</span> : <div className="grid grid-cols-3 w-full gap-0 items-start px-px text-center">{p.sub?.map((s, sIdx) => (<div key={sIdx} className="flex flex-col items-center flex-shrink-0 text-center"><span className={`text-[8px] font-bold mb-0.5 ${isDark ? "text-slate-500" : "text-slate-400"}`}>{s.type}</span>{s.star ? <StarLabel starInfo={s.star} isVertical extraSmall /> : <span className="opacity-10 text-[10px]">ï¼</span>}</div>))}</div>)}
                                            </div>
                                        )) : [1,2,3,4].map(i => <div key={i} className="h-12 border-r last:border-0 animate-pulse bg-slate-200/20"></div>)}
                                    </div>
                                );
                            })}
                        </div>

                        <div className="flex flex-wrap items-center gap-3 py-1 overflow-x-auto no-scrollbar">
                            <div className="flex items-center gap-2">
                                <span className="text-[10px] sm:text-xs font-bold uppercase text-slate-500 whitespace-nowrap">åç¥æ¨™è¨˜:</span>
                                <div className="flex gap-1.5">
                                    {[0, 2, 3, 4, 5, 6].map(n => (
                                        <button key={n} onClick={()=>setThreshold(n)} className={`w-8 h-8 sm:w-10 sm:h-10 rounded-lg border text-[10px] sm:text-sm font-bold transition-all flex items-center justify-center shrink-0 ${threshold === n ? 'bg-emerald-600 border-emerald-500 text-white shadow-lg' : isDark ? 'bg-slate-800 border-slate-700 text-slate-400' : 'bg-white border-slate-200 text-slate-500 shadow-sm'}`}>{n||'OFF'}</button>
                                    ))}
                                </div>
                            </div>
                            {!isLoggedIn && <span className="text-[9px] font-bold text-slate-950 dark:text-slate-400 italic">ç™»å…¥è§£é–æ›´å¤šåŠŸèƒ½</span>}
                        </div>

                        {isAdmin && <AnalysisBox title="å…­åç”²å­" content={chartData?.dayPillarAnalysis} isDark={isDark} />}

                        <div className="divider-gradient my-2 opacity-30"></div>

                        {chartData && chartData.timing && (
                            <div className={`p-4 sm:p-6 rounded-2xl border ${isDark ? "bg-slate-900/60 border-slate-700" : "bg-white border-slate-200 shadow-sm"} text-left`}>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div className="space-y-1">
                                        <p className="text-[12px] font-bold text-emerald-500 uppercase tracking-widest">å‡ºç”Ÿç¯€æ°£è³‡è¨Š</p>
                                        <p className="text-xs sm:text-sm font-bold opacity-90">è¾²æ›†ï¼š<span className="text-emerald-600 dark:text-emerald-400">{toTC(chartData.timing.lunarStr)}</span></p>
                                        <p className="text-[11px] sm:text-xs text-slate-500">
                                            {toTC(chartData.timing.prevNodeName)}å¾Œ {chartData.timing.prevD}å¤© | {toTC(chartData.timing.nextNodeName)}å‰ {chartData.timing.nextD}å¤©
                                        </p>
                                    </div>
                                    <div className="space-y-1">
                                        <p className="text-[12px] font-bold text-blue-500 uppercase tracking-widest">èµ·é‹è³‡è¨Š</p>
                                        <p className="text-xs sm:text-sm font-bold">ç´„ç‚º <span className="text-blue-500">{chartData.timing.startDate}</span></p>
                                        <p className="text-[11px] font-bold opacity-60 text-blue-600">å‡ºç”Ÿå¾Œ {chartData.timing.startAge?.y || 0}æ­² èµ·å¤§é‹</p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {chartData && chartData.fortunePillars && (
                            <React.Fragment>
                                <div className={`rounded-2xl border ${isDark ? "border-slate-700 shadow-2xl" : "border-slate-800/50 shadow-xl"} overflow-hidden overflow-x-auto no-scrollbar`}><table className="fortune-table"><thead className={isDark ? "bg-slate-900 border-b border-slate-700" : "bg-white"}><tr className="text-slate-400 font-bold uppercase tracking-widest text-[9px] sm:text-[10px]"><th className={`w-[11%] text-center ${isDark ? "bg-slate-900" : "bg-white"}`}>é …ç›®</th>{chartData.fortunePillars.map((p, i) => <th key={i} className={`border-l ${isDark ? "border-slate-700" : "border-slate-800/30"} text-center`}>{p.label}</th>)}</tr></thead><tbody className={isDark ? "bg-slate-900/20" : "bg-white"}><tr><td className={`font-bold text-slate-500 text-[9px] sm:text-xs text-center ${isDark ? "bg-slate-900/50" : "bg-slate-100"}`}>åç¥</td>{chartData.fortunePillars.map((p, i) => <td key={i} className={`px-px text-center border-l ${isDark ? "border-slate-700/30" : "border-slate-800/10"}`}>{p.label === 'ç«¥é™' ? null : <StarLabel starInfo={p.tenGod} isFortune extraSmall /> }</td>)}</tr><tr><td className={`font-bold text-slate-500 text-[9px] sm:text-xs text-center ${isDark ? "bg-slate-900/50" : "bg-slate-100"}`}>é‹ç¨‹</td>{chartData.fortunePillars.map((p, i) => (<td key={i} className={`text-center border-l ${isDark ? "border-slate-700/30" : "border-slate-800/10"}`}>{p.stem ? (<div className="flex flex-col items-center justify-center text-center"><div className="flex gap-px items-center justify-center leading-none font-serif font-bold text-[11px] sm:text-lg"><span className={ELEMENT_STYLES[p.stemColor || "none"].color}>{p.stem}</span><span className={ELEMENT_STYLES[p.branchColor || "none"].color}>{p.branch}</span></div></div>) : <span className="opacity-20 text-[10px]">ï¼</span>}</td>))}</tr>
                                <tr><td className={`font-bold text-slate-500 text-[9px] sm:text-xs text-center border-l border-slate-800/10`}>è¥¿æ›†</td>{chartData.fortunePillars.map((p, i) => (<td key={i} className="text-slate-400 font-bold text-[9px] sm:text-xs text-center border-l border-slate-800/10">{p.startYear}</td>))}</tr>
                                <tr><td className={`font-bold text-slate-500 text-[9px] sm:text-xs text-center border-b-2 ${isDark ? "bg-slate-900/50 border-slate-700" : "bg-white border-slate-800/50"}`}>å‘¨æ­²</td>{chartData.fortunePillars.map((p, i) => <td key={i} className={`text-blue-400 font-bold text-[9px] sm:text-xs border-b-2 text-center border-l ${isDark ? "border-slate-800/50" : "border-slate-800/50"}`}>{p.age}</td>)}</tr><tr><td className={`text-slate-700 font-bold text-[9px] sm:text-xs uppercase text-center ${isDark ? "bg-slate-900/50" : "bg-slate-100"}`}>æµå¹´</td>{chartData.fortunePillars.map((p, pIdx) => { const startOffset = 10 - p.flowYears.length; return (<td key={pIdx} className={`p-0 align-top border-l ${isDark ? "border-slate-700/30" : "border-slate-800/10"}`}><div className="flex flex-col">{[...Array(10)].map((_, rowIndex) => { const dataIdx = rowIndex - startOffset; const fy = (dataIdx >= 0) ? p.flowYears[dataIdx] : null; if (!fy) return <div key={rowIndex} className="flow-year-row"></div>; return (<div key={rowIndex} className={`flow-year-row ${rowIndex === 4 ? (isDark ? 'border-b-2 border-slate-600/50' : 'border-b-2 border-slate-400/50') : 'border-b border-slate-800/10'} last:border-0 ${fy.year === CURRENT_REAL_YEAR ? 'highlight-year' : ''}`}><div className="flex items-center gap-px font-serif leading-none font-bold text-[10px] sm:text-[13px] text-center justify-center"><span className={ELEMENT_STYLES[fy.stemColor || "none"].color}>{fy.stem}</span><span className={isLoggedIn ? "" : (isDark ? 'text-slate-400' : 'text-slate-950')}>{fy.branch}</span></div><RomanceIcon level={fy.romance} isCompact /></div>);})}</div></td>);})}</tr></tbody></table></div>
                                {isAdmin && <div className="mt-4"><AnalysisBox title="æµå¹´é»è©•" content={chartData?.flowYearAnalysis} isDark={isDark} /></div>}
                            </React.Fragment>
                        )}

                        <div className={`p-4 sm:p-6 rounded-2xl border transition-all duration-300 ${isDark ? 'bg-slate-900/40 border-slate-800 shadow-2xl' : 'bg-white border-slate-200 shadow-xl'}`}>
                            <div className="flex flex-row items-center justify-between gap-1 mb-6 sm:mb-8 text-left">
                                <div className="flex items-center gap-1 sm:gap-3 shrink-0">
                                    <div className="w-1 h-5 sm:w-1.5 sm:h-6 bg-blue-500 rounded-full"></div>
                                    <h2 className="font-black text-sm sm:text-xl tracking-tighter sm:tracking-widest uppercase">æµæœˆæµæ—¥</h2>
                                </div>
                                <div className="flex items-center gap-1.5 sm:gap-3 shrink-0">
                                    <div className="flex flex-col gap-0.5 sm:gap-1">
                                        <span className="text-[6px] sm:text-[8px] font-bold opacity-40 uppercase">æŸ¥è©¢è¥¿å…ƒ</span>
                                        <input type="number" value={calYear} onChange={(e)=> setCalYear(parseInt(e.target.value) || new Date().getFullYear())} className={`rounded px-1 py-0.5 text-[10px] sm:text-xs border h-7 sm:h-9 appearance-none w-14 sm:w-24 max-w-[65px] sm:max-w-none ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`} />
                                    </div>
                                    <div className="flex flex-col gap-0.5 sm:gap-1">
                                        <span className="text-[6px] sm:text-[8px] font-bold opacity-40 uppercase">æŸ¥è©¢æœˆä»½</span>
                                        <select value={calMonth} onChange={(e)=> setCalMonth(parseInt(e.target.value) || 1)} className={`rounded px-1 py-0.5 text-[10px] sm:text-xs border h-7 sm:h-9 appearance-none w-14 sm:w-24 max-w-[65px] sm:max-w-none ${isDark ? "bg-slate-950 border-slate-800 text-slate-100" : "bg-white border-slate-200"}`}>{Array.from({length:12}, (_,i)=><option key={i+1} value={i+1}>{i+1}æœˆ</option>)}</select>
                                    </div>
                                </div>
                            </div>
                            
                            <div className="mb-8 w-full overflow-hidden">
                                <table className="w-full table-fixed border-collapse border border-slate-700/30">
                                    <thead><tr className={isDark ? "bg-slate-800/50" : "bg-slate-100/50"}><th className="p-0.5 border border-slate-700/30 text-[7px] sm:text-xs font-bold w-[13%] sm:w-20">æœˆä»½</th>{Array.from({length:12}, (_,i)=><th key={i} className="p-0.5 border border-slate-700/30 text-[7px] sm:text-xs font-bold">{i+1}</th>)}</tr></thead>
                                    <tbody>
                                        <tr>
                                            <td className="p-0.5 border border-slate-700/30 text-[7px] sm:text-xs font-bold text-center">æµæœˆ</td>
                                            {calendarData?.flowMonths?.map((m, i) => (
                                                <td key={i} className="p-0 border border-slate-700/30 font-serif font-bold text-center relative h-10 sm:h-12 overflow-hidden">
                                                    <div className="flex flex-row items-center justify-center gap-0 text-[clamp(8px,2.1vw,14px)] sm:text-base leading-none w-full h-full">
                                                        <span className={ELEMENT_STYLES[isLoggedIn ? m.stemColor : "none"].color}>{m.stem}</span>
                                                        <span className={isDark ? "text-slate-400" : "text-slate-600"}>{m.branch}</span>
                                                    </div>
                                                    <RomanceIcon level={m.romance} isCompact />
                                                </td>
                                            )) || Array.from({length:12}, (_,i)=><td key={i} className="p-1 border border-slate-700/30 opacity-20 text-center text-[7px]">...</td>)}
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            {isCalLoading && <div className="h-1 loading-shimmer w-full rounded-full mb-4"></div>}
                            
                            <div className="grid grid-cols-7 gap-1 sm:gap-2">
                                {['ä¸€','äºŒ','ä¸‰','å››','äº”','å…­','æ—¥'].map(w => (<div key={w} className="text-center text-[8px] sm:text-[10px] font-black opacity-40 pb-1.5 border-b border-slate-700/20 mb-1.5">é€±{w}</div>))}
                                {calendarData?.days ? (
                                    <React.Fragment>
                                        {Array.from({length: calendarData.days[0].weekday}).map((_, i) => (<div key={`empty-${i}`} className="h-12 sm:h-16 opacity-0"></div>))}
                                        {calendarData.days.map((d, idx) => (
                                            <div key={idx} className={`p-0.5 sm:p-2 rounded-lg border flex flex-col transition-all relative h-12 sm:h-auto ${d.day === new Date().getDate() && calMonth === (new Date().getMonth()+1) && calYear === new Date().getFullYear() ? 'ring-1.5 ring-blue-500 bg-blue-500/5 shadow-inner' : isDark ? 'bg-slate-950 border-slate-800 shadow-sm' : 'bg-white border-slate-200 shadow-sm'}`}>
                                                <div className="flex justify-between items-start w-full h-2.5 sm:h-5">
                                                    <div className="text-[7px] sm:text-[10px] font-black opacity-30 leading-none pl-0.5">{d.day}</div>
                                                    <div className="relative w-3 h-3 sm:w-5 sm:h-5">
                                                        <RomanceIcon level={d.romance} isCompact />
                                                    </div>
                                                </div>
                                                <div className="flex items-center justify-center gap-0 font-serif font-bold text-[clamp(10px,4.5vw,14px)] sm:text-[14px] leading-none mt-1 sm:mt-1.5">
                                                    <span className={ELEMENT_STYLES[isLoggedIn ? d.stemColor : "none"].color}>{d.stem}</span>
                                                    <span className={isDark ? "text-slate-300" : "text-slate-700"}>{d.branch}</span>
                                                </div>
                                            </div>
                                        ))}
                                    </React.Fragment>
                                ) : <div className="col-span-full py-10 opacity-30 italic text-[10px]">æ­£åœ¨è¼‰å…¥æ•¸æ“š...</div>}
                            </div>
                        </div>

                        <div className="mt-10 mb-6 pb-6 border-slate-200 dark:border-slate-800 text-center"><p className="text-[clamp(11.5px,2.8vw,16px)] leading-relaxed md:leading-loose opacity-70 font-medium max-w-[50rem] md:max-w-[85ch] mx-auto font-serif italic tracking-wide">â€œå‘½ç†ä¸æ˜¯é è¨€æœªä¾†çš„æ°´æ™¶çƒï¼Œè€Œæ˜¯ä¸€ä»½è§£ç¢¼ä½ çš„ã€Œå‡ºå» è¨­å®šã€èªªæ˜æ›¸ã€‚å‘½ç›¤æ­ç¤ºçš„æ˜¯æ¯å€‹äººç¨ä¸€ç„¡äºŒçš„åŸå§‹åŠ‡æœ¬ã€‚å­¸å‘½ç†ï¼Œæ˜¯å­¸æœƒé–±è®€è‡ªå·±ï¼Œç”¨ç†è§£å–ä»£è¿·ä¿¡ã€‚ç†è§£å‘½çš„é‚è¼¯ï¼Œå°±èƒ½åœ¨æ•¬ç•ä¸­æ‰¾åˆ°è‡ªä¿¡ï¼Œè®“å‘½é‹æŒæ¡åœ¨è‡ªå·±æ‰‹è£¡ã€‚â€</p></div>
                    </div>

                    <footer className={`py-8 sm:py-16 border-t mt-auto transition-colors duration-300 ${isDark ? 'bg-slate-950 border-slate-800 text-slate-400' : 'bg-white border-slate-200 text-slate-500'}`}>
                        <div className="max-w-[1200px] mx-auto px-4 sm:px-8 text-center sm:text-left">
                            <div className="flex flex-col md:flex-row justify-between items-center gap-6 text-left">
                                <div className="flex flex-row items-center justify-between md:justify-start gap-4 sm:gap-10 w-full md:w-auto">
                                    <div className="flex flex-col"><span className="text-[10px] uppercase font-black tracking-widest opacity-60 leading-tight">Created by</span><span className="text-xs sm:text-sm font-bold tracking-tight">kasimchang</span></div>
                                    <div className="h-8 w-px bg-slate-200 dark:bg-slate-800 hidden md:block"></div>
                                    <a href="https://www.msf.org.tw/" target="_blank" className="group flex flex-row items-center gap-2"><img src="https://upload.wikimedia.org/wikipedia/en/thumb/b/b9/M%C3%A9decins_Sans_Fronti%C3%A8res_%28logo%29.svg/500px-M%C3%A9decins_Sans_Fronti%C3%A8res_%28logo%29.svg.png" alt="MSF" className="h-7 sm:h-10 w-auto object-contain" onError={(e)=>e.target.style.display='none'} /><span className="text-[9px] uppercase font-black text-red-500/80 leading-none whitespace-nowrap">ææ¬¾æ”¯æŒåšå¥½äº‹</span></a>
                                    <div className="h-8 w-px bg-slate-200 dark:bg-slate-800 hidden md:block"></div>
                                    <div className="flex flex-col">
                                        <span className="text-[10px] uppercase font-black tracking-widest opacity-60 leading-tight">Copyright</span>
                                        <span className="text-xs sm:text-sm font-bold tracking-tight italic whitespace-nowrap">Â© 2026 LuminousPath</span>
                                    </div>
                                </div>
                                <div className="flex flex-col items-center md:items-end text-center md:text-right w-full md:w-auto mt-2 md:mt-0">
                                    <span className="text-[10px] uppercase font-black tracking-[0.3em] text-emerald-500 mb-1 leading-none">LuminousPath Pro</span>
                                    <p className="text-[11px] font-medium opacity-60">æ±æ–¹å‘½ç†çµæ§‹åˆ†æå¼•æ“</p>
                                </div>
                            </div>
                        </div>
                    </footer>
                </div>
            );
        };
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
